<div class="cancer-question">
  <div class="container">
    <div class="cancer-question__image">
      <img src="{{ section.settings.image | img_url: 'master' }}" alt="Image">
    </div>
    <div class="cancer-question__content">
      <div class="cancer-question__content-wrapper">
        <div class="cancer-question__text">
          <h2 id="cancer-question-heading">{{ section.settings.heading }}</h2>
          <p id="cancer-question-subheading">{{ section.settings.subheading }}</p>
          <p id="cancer-question-why">{{ section.settings.why }}</p>
        </div>
        <div class="cancer-question__blocks">
          {%- assign current_stage = '' -%}
          {%- for block in section.blocks -%}
            {%- if block.type == 'option' -%}
              {%- assign block_stage = block.settings.stage | append: '' -%}
              {%- if current_stage != block_stage -%}
                {%- unless current_stage == '' -%}</div>{%- endunless -%}
                <div class="cancer-question__stage" data-stage="{{ block_stage }}" data-question="{{ block.settings.question | escape }}" data-subquestion="{{ block.settings.subquestion | escape }}" data-why="{{ block.settings.why | escape }}"{%- unless current_stage == '' -%} style="display:none"{%- endunless -%}>
                {%- assign current_stage = block_stage -%}
              {%- endif -%}
              <div class="cancer-question__block" data-stage="{{ block.settings.stage }}" data-value="{{ block.settings.value }}">
                <div class="cancer-question__block-content">
                  <div class="cancer-question__block-icon"></div>
                  <div class="cancer-question__block-text">
                    <p class="cancer-question__block-text--title">{{ block.settings.title }}</p>
                    <p class="cancer-question__block-text--desc">{{ block.settings.description }}</p>
                  </div>
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
          {%- if current_stage != '' -%}</div>{%- endif -%}
          <!-- New answer option with link to quiz -->
          <div class="cancer-question__block" data-url="/pages/quiz">
            <div class="cancer-question__block-content">
              <div class="cancer-question__block-icon"></div>
              <div class="cancer-question__block-text">
                <p class="cancer-question__block-text--title">Need More Guidance?</p>
                <p class="cancer-question__block-text--desc">Take our oncologist- and naturopath-designed quiz for a fully personalized, cancer survivor-specific wellness routine.</p>
              </div>
            </div>
          </div>
        </div>
        <div class="canver-question__buttons">
          <p style="color: #333333;"><strong>Need quick help? Chat with us!</strong></p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .cancer-question .container {
    background-color: {{ section.settings.bg_color }};
    display: flex;
  }

  .cancer-question__stage {
    width: 100%;
  }

  #cancer-question-why {
    margin-top: 10px;
  }

  .cancer-question__block {
    cursor: pointer;
    display: flex;
    align-items: center;
    padding: 20px;
    border: 2px solid #ccc;
    border-radius: 20px;
    margin-bottom: 20px;
    background-color: #fff;
    width: 100%;
  }

  .cancer-question__block:hover {
    background-color: #f0f0f0;
  }

  .cancer-question__block-content {
    display: flex;
    align-items: center;
    width: 100%;
  }

  .cancer-question__block-icon {
    width: 40px;
    height: 40px;
    background-color: #fff;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 20px;
  }

  .cancer-question__block-text {
    display: flex;
    flex-direction: column;
    width: calc(100% - 60px);
  }

  .cancer-question__block-text--title {
    font-weight: bold;
    font-size: 16px;
  }

  .cancer-question__block-text--desc {
    color: #666;
    font-size: 14px;
  }

  .quiz-button {
    display: none; /* Hide the original quiz button */
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    function updateTexts(stageEl) {
      var headingEl = document.getElementById('cancer-question-heading');
      var subEl = document.getElementById('cancer-question-subheading');
      var whyEl = document.getElementById('cancer-question-why');
      if (stageEl) {
        headingEl.textContent = stageEl.getAttribute('data-question') || '';
        subEl.textContent = stageEl.getAttribute('data-subquestion') || '';
        whyEl.textContent = stageEl.getAttribute('data-why') || '';
      }
    }

    var answers = {};
    var totalStages = document.querySelectorAll('.cancer-question__stage').length;
    updateTexts(document.querySelector('.cancer-question__stage'));

    var resultMap = {
      {%- assign result_blocks = section.blocks | where: 'type', 'result' -%}
      {%- for block in result_blocks -%}
        "{{ block.settings.combination }}": "{{ block.settings.product.url }}"{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    };

    document.addEventListener('click', function(e) {
      var target = e.target.closest('.cancer-question__block');
      if (!target) return;
      var url = target.getAttribute('data-url');
      if (url) {
        window.location.href = url;
        return;
      }
      var stage = parseInt(target.getAttribute('data-stage'));
      var value = target.getAttribute('data-value');
      answers[stage] = value;
      var nextStage = stage + 1;
      if (nextStage <= totalStages) {
        document.querySelectorAll('.cancer-question__stage').forEach(function(el) { el.style.display = 'none'; });
        var next = document.querySelector('.cancer-question__stage[data-stage="' + nextStage + '"]');
        if (next) { next.style.display = 'block'; updateTexts(next); }
      } else {
        var keyParts = [];
        for (var i = 1; i <= totalStages; i++) { keyParts.push(answers[i]); }
        var finalUrl = resultMap[keyParts.join('|')];
        if (finalUrl) { window.location.href = finalUrl; }
      }
    });
  });
</script>

{% schema %}
{
  "name": "Cancer Question",
  "settings": [
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "textarea",
      "id": "why",
      "label": "Why We Ask"
    }
  ],
  "blocks": [
    {
      "type": "option",
      "name": "Question Option",
      "settings": [
        {
          "type": "number",
          "id": "stage",
          "label": "Stage Number"
        },
        {
          "type": "text",
          "id": "question",
          "label": "Question"
        },
        {
          "type": "text",
          "id": "subquestion",
          "label": "Sub Question"
        },
        {
          "type": "textarea",
          "id": "why",
          "label": "Why We Ask"
        },
        {
          "type": "text",
          "id": "value",
          "label": "Answer Value"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description"
        }
      ]
    },
    {
      "type": "result",
      "name": "Result Mapping",
      "settings": [
        {
          "type": "text",
          "id": "combination",
          "label": "Answer Combination (value1|value2|...)"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Cancer Question"
    }
  ]
}
{% endschema %}
