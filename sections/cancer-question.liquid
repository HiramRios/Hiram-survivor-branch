<div class="cancer-question">
  <div class="container">
    <div class="cancer-question__image">
      <img src="{{ section.settings.image | img_url: 'master' }}" alt="Image">
    </div>
    <div class="cancer-question__content">
      <div class="cancer-question__content-wrapper">
        <div class="cancer-question__text">
          <h2>{{ section.settings.heading }}</h2>
          <p>{{ section.settings.subheading }}</p>
        </div>
        <div id="cancer-quiz" class="cancer-question__blocks" data-step-count="{{ section.blocks.size }}"></div>
      </div>
    </div>
  </div>
</div>

{% for block in section.blocks %}
  <script type="application/json" id="cancer-step-{{ forloop.index0 }}" data-title="{{ block.settings.title | escape }}">
    {{ block.settings.questions_json }}
  </script>
{% endfor %}

<style>
  .cancer-question .container {
    background-color: {{ section.settings.bg_color }};
    display: flex;
  }

  .cancer-question__block {
    cursor: pointer;
    display: flex;
    align-items: center;
    padding: 20px;
    border: 2px solid #ccc;
    border-radius: 20px; 
    margin-bottom: 20px;
    background-color: #fff;
    width: 100%;
  }

  .cancer-question__block:hover {
    background-color: #f0f0f0;
  }

  .cancer-question__block-content {
    display: flex;
    align-items: center;
    width: 100%;
  }

  .cancer-question__block-icon {
    width: 40px;
    height: 40px;
    background-color: #fff;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 20px;
  }

  .cancer-question__block-text {
    display: flex;
    flex-direction: column;
    width: calc(100% - 60px);
  }

  .cancer-question__block-text--title {
    font-weight: bold;
    font-size: 16px; 
  }

  .cancer-question__block-text--desc {
    color: #666;
    font-size: 14px;
  }

  .quiz-question {
    margin-bottom: 20px;
  }

  .quiz-question__title {
    font-weight: bold;
    margin-bottom: 10px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var quizContainer = document.getElementById('cancer-quiz');
    if (!quizContainer) return;
    var stepCount = parseInt(quizContainer.getAttribute('data-step-count'), 10) || 0;
    var steps = [];
    for (var i = 0; i < stepCount; i++) {
      var dataTag = document.getElementById('cancer-step-' + i);
      if (!dataTag) continue;
      var qs = [];
      try {
        qs = JSON.parse(dataTag.textContent);
      } catch (e) {
        console.warn('Invalid JSON in cancer-question step', i);
      }
      steps.push({
        title: dataTag.getAttribute('data-title'),
        questions: qs
      });
      dataTag.parentNode.removeChild(dataTag);
    }

    var currentStep = 0;
    var answers = {};

    function renderStep() {
      quizContainer.innerHTML = '';
      var step = steps[currentStep];
      if (!step) return;

      var stepEl = document.createElement('div');
      stepEl.className = 'quiz-step';

      if (step.title) {
        var h3 = document.createElement('h3');
        h3.textContent = step.title;
        stepEl.appendChild(h3);
      }

      step.questions.forEach(function(q, qi) {
        var qEl = document.createElement('div');
        qEl.className = 'quiz-question';
        var qTitle = document.createElement('p');
        qTitle.className = 'quiz-question__title';
        qTitle.textContent = q.question;
        qEl.appendChild(qTitle);

        q.options.forEach(function(opt) {
          var optionEl = document.createElement('div');
          optionEl.className = 'cancer-question__block';
          var inner = document.createElement('div');
          inner.className = 'cancer-question__block-content';
          var icon = document.createElement('div');
          icon.className = 'cancer-question__block-icon';
          var textWrap = document.createElement('div');
          textWrap.className = 'cancer-question__block-text';
          var titleEl = document.createElement('p');
          titleEl.className = 'cancer-question__block-text--title';
          titleEl.textContent = opt.label;
          textWrap.appendChild(titleEl);
          inner.appendChild(icon);
          inner.appendChild(textWrap);
          optionEl.appendChild(inner);

          optionEl.addEventListener('click', function() {
            var siblings = qEl.querySelectorAll('.cancer-question__block');
            Array.prototype.forEach.call(siblings, function(s) { s.classList.remove('active'); });
            optionEl.classList.add('active');
            answers['step' + currentStep + 'q' + qi] = opt.value || opt.label;
            if (opt.url) {
              window.location.href = opt.url;
            } else {
              checkAdvance();
            }
          });

          qEl.appendChild(optionEl);
        });

        stepEl.appendChild(qEl);
      });

      quizContainer.appendChild(stepEl);
    }

    function checkAdvance() {
      var step = steps[currentStep];
      var allAnswered = step.questions.every(function(q, qi) {
        return Object.prototype.hasOwnProperty.call(answers, 'step' + currentStep + 'q' + qi);
      });
      if (allAnswered) {
        currentStep++;
        if (currentStep < steps.length) {
          renderStep();
        }
      }
    }

    renderStep();
  });
</script>

{% schema %}
{
  "name": "Cancer Question",
  "settings": [
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    }
  ],
  "blocks": [
    {
      "type": "step",
      "name": "Step",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Step Title"
        },
        {
          "type": "textarea",
          "id": "questions_json",
          "label": "Questions JSON",
          "info": "Provide a JSON array of questions and options. Final step options may include a \"url\" to redirect to a product."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Cancer Question"
    }
  ]
}
{% endschema %}
